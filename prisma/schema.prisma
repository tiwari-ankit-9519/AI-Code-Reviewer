generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum SubscriptionTier {
  STARTER
  HERO
  LEGEND
}

enum SubscriptionStatus {
  ACTIVE
  TRIALING
  CANCELLED
  EXPIRED
  PAST_DUE
}

enum PaymentProvider {
  STRIPE
  PADDLE
  MANUAL
}

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  name          String
  passwordHash  String
  avatar        String?
  emailVerified DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  subscriptionTier        SubscriptionTier   @default(STARTER)
  subscriptionStatus      SubscriptionStatus @default(ACTIVE)
  subscriptionStartDate   DateTime?
  subscriptionEndDate     DateTime?
  trialEndsAt             DateTime?
  isTrialUsed             Boolean            @default(false)
  monthlySubmissionCount  Int                @default(0)
  lastSubmissionReset     DateTime           @default(now())
  submissionLimitNotified Boolean            @default(false)
  stripeCustomerId        String?            @unique

  submissions         CodeSubmission[]
  apiKeys             ApiKey[]
  accounts            Account[]
  sessions            Session[]
  settings            UserSettings?
  usageRecords        UsageRecord[]
  rateLimits          RateLimitBucket[]
  subscriptions       Subscription[]
  subscriptionHistory SubscriptionHistory[]

  @@index([email])
  @@index([subscriptionTier])
  @@index([subscriptionStatus])
  @@index([stripeCustomerId])
  @@map("users")
}

model Account {
  id                String  @id @default(uuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(uuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@id([identifier, token])
  @@map("verification_tokens")
}

model ApiKey {
  id         String    @id @default(uuid())
  name       String
  key        String    @unique
  lastUsedAt DateTime?
  createdAt  DateTime  @default(now())
  expiresAt  DateTime?

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([key])
  @@map("api_keys")
}

model CodeSubmission {
  id          String   @id @default(uuid())
  code        String   @db.Text
  language    String
  fileName    String?
  fileSize    Int
  linesOfCode Int
  status      String   @default("pending")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  analysis AnalysisResult?
  issues   Issue[]

  @@index([userId])
  @@index([createdAt])
  @@index([status])
  @@index([language])
  @@index([userId, createdAt])
  @@map("code_submissions")
}

model AnalysisResult {
  id                   String @id @default(uuid())
  securityScore        Int
  performanceScore     Int
  qualityScore         Int
  complexityScore      Int
  maintainabilityScore Int
  overallScore         Int

  securityIssues    Json @default("[]")
  performanceIssues Json @default("[]")
  codeSmells        Json @default("[]")
  bugRisks          Json @default("[]")
  styleSuggestions  Json @default("[]")

  aiModel          String
  aiProvider       String
  promptTokens     Int
  completionTokens Int
  analysisTime     Int

  summary         String @db.Text
  recommendations Json   @default("[]")

  createdAt DateTime @default(now())

  submissionId String         @unique
  submission   CodeSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  @@index([overallScore])
  @@index([createdAt])
  @@map("analysis_results")
}

model Issue {
  id          String @id @default(uuid())
  type        String
  severity    String
  title       String
  description String @db.Text

  lineStart   Int
  lineEnd     Int
  column      Int?
  codeSnippet String @db.Text

  suggestedFix String? @db.Text
  fixedCode    String? @db.Text

  cweId String?
  cveId String?

  confidence  Float
  automatable Boolean @default(false)

  createdAt DateTime @default(now())

  submissionId String
  submission   CodeSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  @@index([submissionId])
  @@index([type])
  @@index([severity])
  @@index([submissionId, severity])
  @@map("issues")
}

model Subscription {
  id     String             @id @default(uuid())
  userId String
  user   User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  tier   SubscriptionTier
  status SubscriptionStatus

  paymentProvider      PaymentProvider
  stripeCustomerId     String?
  stripeSubscriptionId String?         @unique
  stripePriceId        String?

  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  cancelAtPeriodEnd  Boolean   @default(false)
  canceledAt         DateTime?

  amount   Int
  currency String @default("usd")

  metadata  Json     @default("{}")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([stripeSubscriptionId])
  @@index([status])
  @@map("subscriptions")
}

model SubscriptionHistory {
  id       String            @id @default(uuid())
  userId   String
  user     User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  action   String
  fromTier SubscriptionTier?
  toTier   SubscriptionTier
  amount   Int?
  reason   String?
  metadata Json              @default("{}")

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
  @@index([action])
  @@map("subscription_history")
}

model TierUsageAnalytics {
  id                    String           @id @default(uuid())
  tier                  SubscriptionTier
  totalUsers            Int
  activeUsers           Int
  totalSubmissions      Int
  avgSubmissionsPerUser Float
  conversionRate        Float?
  churnRate             Float?
  mrr                   Int?

  periodStart DateTime
  periodEnd   DateTime
  createdAt   DateTime @default(now())

  @@index([tier])
  @@index([periodStart, periodEnd])
  @@index([createdAt])
  @@map("tier_usage_analytics")
}

model AnalyticsSnapshot {
  id String @id @default(uuid())

  totalSubmissions    Int
  totalIssuesFound    Int
  avgSecurityScore    Float
  avgPerformanceScore Float
  avgQualityScore     Float

  criticalIssues Int
  highIssues     Int
  mediumIssues   Int
  lowIssues      Int

  topSecurityIssues    Json
  topPerformanceIssues Json
  topCodeSmells        Json

  languageDistribution Json

  periodStart  DateTime
  periodEnd    DateTime
  snapshotDate DateTime @default(now())

  userId String?

  @@index([userId])
  @@index([snapshotDate])
  @@map("analytics_snapshots")
}

model CodePattern {
  id          String @id @default(uuid())
  name        String
  description String @db.Text
  category    String

  language    String
  badPattern  String @db.Text
  goodPattern String @db.Text

  regexPattern String? @db.Text
  severity     String

  documentation String?
  cweReference  String?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([language])
  @@index([category])
  @@index([isActive])
  @@map("code_patterns")
}

model UserSettings {
  id String @id @default(uuid())

  enableSecurityChecks    Boolean @default(true)
  enablePerformanceChecks Boolean @default(true)
  enableStyleChecks       Boolean @default(true)
  minimumSeverity         String  @default("low")

  emailOnCompletion    Boolean @default(true)
  emailOnCriticalIssue Boolean @default(true)

  defaultAiModel String @default("groq-llama-3.1-70b")
  maxCodeSize    Int    @default(100000)

  theme       String @default("system")
  editorTheme String @default("vs-dark")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_settings")
}

model UsageRecord {
  id String @id @default(uuid())

  resourceType String
  quantity     Int

  tokensUsed    Int   @default(0)
  estimatedCost Float @default(0)

  metadata  Json     @default("{}")
  timestamp DateTime @default(now())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([timestamp])
  @@index([resourceType])
  @@map("usage_records")
}

model RateLimitBucket {
  id String @id @default(uuid())

  resource String
  limit    Int
  current  Int    @default(0)

  windowStart DateTime
  windowEnd   DateTime

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, resource, windowStart])
  @@index([userId])
  @@index([windowEnd])
  @@map("rate_limit_buckets")
}
